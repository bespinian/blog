<!DOCTYPE html>
<html lang="en-us">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Blue Green Deployment on Cloud Foundry | bespinian Blog</title>
<link rel="stylesheet" href="https://blog.bespinian.io//css/style.css">
<link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css">

<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.6.0/styles/androidstudio.min.css">


<section class="section">
  <div class="container">
    <nav class="nav">
      <div class="nav-left">
        <a class="nav-item" href="https://blog.bespinian.io/"><h1 class="title is-4">bespinian Blog</h1></a>
      </div>
      <div class="nav-right">
        <nav class="nav-item level is-mobile">
          
          <a class="level-item" href="https://bespinian.io/">
            <span class="icon">
              <i class="fa fa-globe"></i>
            </span>
          </a>
          
          <a class="level-item" href="https://github.com/bespinian">
            <span class="icon">
              <i class="fa fa-github"></i>
            </span>
          </a>
          
          <a class="level-item" href="https://twitter.com/bespinian">
            <span class="icon">
              <i class="fa fa-twitter"></i>
            </span>
          </a>
          
          <a class="level-item" href="/index.xml">
            <span class="icon">
              <i class="fa fa-rss"></i>
            </span>
          </a>
          
        </nav>
      </div>
    </nav>
  </div>
</section>

<section class="section">
  <div class="container">
    <h2 class="subtitle is-6">December 12, 2016</h2>
    <h1 class="title">Blue Green Deployment on Cloud Foundry</h1>
    <div class="content">
      <p>Imagine you have one of your apps in production and want to <code>cf push</code> an update to it. If you do so, your app will experience a short downtime because CF needs to stop your old application and then power up the new one. During this short period of time, your users will be receiving <code>404</code>s when trying to access your application. Now, what if the new version of your app has an error in it and doesn&rsquo;t even start on Cloud Foundry? Your users will face an even longer downtime until you have found and fixed the bug.</p>
<p>To prevent these inconveniences for your users, Cloud Foundry allows you to do a so called &ldquo;Blue-Green Deployment&rdquo;. I won&rsquo;t go into the depths of this concept because you can read all about it in the <a href="https://docs.cloudfoundry.org/devguide/deploy-apps/blue-green.html">Cloud Foundry documentation</a>. Generally, it allows you to have two instances of your application running at the same time while one is the old version and one is already the new version. Your users are then being load balanced between the two apps and, as soon as the new version is running correctly, the old one is shut down.</p>
<p>Cloud Foundry doesn&rsquo;t provide this functionality out of the box. That&rsquo;s why I wrote a simple shell script to do this blue-green deployment for you.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e">#!/usr/bin/env bash
</span><span style="color:#75715e"></span>
<span style="color:#75715e"># Your ENV variables (Should be set externally, e.g. export CF_USERNAME=&#34;myUsername123&#34;)</span>
<span style="color:#75715e"># CF_API=</span>
<span style="color:#75715e"># CF_SHARED_DOMAIN=</span>
<span style="color:#75715e"># CF_USERNAME=</span>
<span style="color:#75715e"># CF_PASSWORD=</span>
<span style="color:#75715e"># CF_ORG=</span>
<span style="color:#75715e"># CF_SPACE=</span>

max_health_checks<span style="color:#f92672">=</span><span style="color:#ae81ff">20</span>
expected_response<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;200&#34;</span>
temp_suffix<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;-temp&#34;</span>

<span style="color:#75715e"># Read from manifest.yml</span>
app_name<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>grep <span style="color:#e6db74">&#34; name:&#34;</span> manifest.yml | sed <span style="color:#e6db74">&#39;s/.*://;s/ //g&#39;</span><span style="color:#66d9ef">)</span>
domain<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>grep <span style="color:#e6db74">&#34; domain: &#34;</span> manifest.yml | sed <span style="color:#e6db74">&#39;s/.*://;s/ //g&#39;</span><span style="color:#66d9ef">)</span>
hostname<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>grep <span style="color:#e6db74">&#34; host: &#34;</span> manifest.yml | sed <span style="color:#e6db74">&#39;s/.*://;s/ //g&#39;</span><span style="color:#66d9ef">)</span>

<span style="color:#75715e"># Set default values</span>
: <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>domain:=<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>CF_SHARED_DOMAIN<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
: <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>hostname:=<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>app_name<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>

<span style="color:#75715e"># Set up temporary app</span>
temp_app_name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>app_name<span style="color:#e6db74">}${</span>temp_suffix<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
temp_domain<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>CF_SHARED_DOMAIN<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
temp_hostname<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>app_name<span style="color:#e6db74">}${</span>temp_suffix<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>

<span style="color:#75715e"># CF Login</span>
cf api <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>CF_API<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
cf login <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>CF_USERNAME<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>CF_PASSWORD<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
cf target -o <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>CF_ORG<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> -s <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>CF_SPACE<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>

<span style="color:#75715e"># Push Green</span>
cf push <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>temp_app_name<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> --no-route

<span style="color:#75715e"># Map temporary route to Green</span>
cf map-route <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>temp_app_name<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>temp_domain<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> -n <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>temp_hostname<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>

<span style="color:#75715e"># Wait for Green to be ready to serve</span>
iterations<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
<span style="color:#66d9ef">while</span> <span style="color:#f92672">[[</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>iterations<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> -lt <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>max_health_checks<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">]]</span>
<span style="color:#66d9ef">do</span>
  response<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>curl -sIL -w <span style="color:#e6db74">&#34;%{http_code}&#34;</span> -o /dev/null <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>temp_hostname<span style="color:#e6db74">}</span><span style="color:#e6db74">.</span><span style="color:#e6db74">${</span>temp_domain<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">)</span>
  <span style="color:#66d9ef">if</span> <span style="color:#f92672">[[</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>response<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>expected_response<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">]]</span>; <span style="color:#66d9ef">then</span>
    printf <span style="color:#e6db74">&#34;\n%s&#34;</span> <span style="color:#e6db74">&#34;Got expected </span><span style="color:#e6db74">${</span>response<span style="color:#e6db74">}</span><span style="color:#e6db74"> response&#34;</span>
    break
  <span style="color:#66d9ef">else</span>
    iterations<span style="color:#f92672">=</span><span style="color:#66d9ef">$((</span> iterations <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span> <span style="color:#66d9ef">))</span>
    sleep <span style="color:#ae81ff">3</span> <span style="color:#f92672">&amp;&amp;</span> printf <span style="color:#e6db74">&#34;\n%s&#34;</span> <span style="color:#e6db74">&#34;Waiting for </span><span style="color:#e6db74">${</span>expected_response<span style="color:#e6db74">}</span><span style="color:#e6db74"> response... Got </span><span style="color:#e6db74">${</span>response<span style="color:#e6db74">}</span><span style="color:#e6db74"> (</span><span style="color:#e6db74">${</span>iterations<span style="color:#e6db74">}</span><span style="color:#e6db74">/</span><span style="color:#e6db74">${</span>max_health_checks<span style="color:#e6db74">}</span><span style="color:#e6db74">)&#34;</span>
  <span style="color:#66d9ef">fi</span>
<span style="color:#66d9ef">done</span>

<span style="color:#66d9ef">if</span> <span style="color:#f92672">[[</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>iterations<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>max_health_checks<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">]]</span>; <span style="color:#66d9ef">then</span>
  printf <span style="color:#e6db74">&#34;\n%s\n\n&#34;</span> <span style="color:#e6db74">&#34;Couldn&#39;t get </span><span style="color:#e6db74">${</span>expected_response<span style="color:#e6db74">}</span><span style="color:#e6db74"> response. Reverting...&#34;</span>

  <span style="color:#75715e"># Delete temporary route</span>
  cf delete-route <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>temp_domain<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> -n <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>temp_hostname<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> -f

  <span style="color:#75715e"># Stop temporary app</span>
  cf stop <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>temp_app_name<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>

  exit <span style="color:#ae81ff">1</span>
<span style="color:#66d9ef">fi</span>

<span style="color:#75715e"># Load balance route between Blue and Green</span>
cf map-route <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>temp_app_name<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>domain<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> -n <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>hostname<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>

<span style="color:#75715e"># Remove Blue from load balancing</span>
cf unmap-route <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>app_name<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>domain<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> -n <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>hostname<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>

<span style="color:#75715e"># Delete temporary route</span>
cf delete-route -f <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>temp_domain<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> -n <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>temp_hostname<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>

<span style="color:#75715e"># Delete old app</span>
cf delete -f -r <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>app_name<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>

<span style="color:#75715e"># Rename Green to old app name</span>
cf rename <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>temp_app_name<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>app_name<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</code></pre></div><p>The script tries to guess some variables from your <code>manifest.yml</code> file but you&rsquo;ll still need to set some environment variables for a successful deployment:</p>
<ul>
<li><code>CF_API</code>: The API endpoint of the CF instance you want to use (e.g. <code>https://api.lyra-836.appcloud.swisscom.com</code>)</li>
<li><code>CF_SHARED_DOMAIN</code>: The shared domain you want to use for temporary routes used to smoke test your app</li>
<li><code>CF_USERNAME</code>: Your Cloud Foundry username</li>
<li><code>CF_PASSWORD</code>: Your Cloud Foundry password</li>
<li><code>CF_ORG</code>: The Cloud Foundry org you want to deploy to</li>
<li><code>CF_SPACE</code>: The Cloud Foundry space you want to deploy to</li>
</ul>
<p>As soon as you&rsquo;ve set all of these variables, you can simply execute the script and it will do a verbose blue-green deployment for you. The script will deploy the new version of your app and check for it to get healthy. You can change the <code>expected_response</code> parameter to something else like <code>401</code> if your app doesn&rsquo;t return a <code>200</code> status code without authentication.</p>
<h2 id="caveats">Caveats</h2>
<ul>
<li>The script currently doesn&rsquo;t work if your app does not use a route.</li>
<li>The script currently doesn&rsquo;t work if your app uses more than one routes.</li>
</ul>
<h2 id="further-reading">Further reading</h2>
<p>There are two plugins for the Cloud Foundry CLI that also automate certain steps of blue-green deployment:</p>
<ul>
<li><a href="https://github.com/contraband/autopilot">Autopilot</a></li>
<li><a href="https://github.com/bluemixgaragelondon/cf-blue-green-deploy">BlueGreenDeploy</a></li>
</ul>
<p>My script is there to show you what happens behind the curtains and to be used by CI/CD systems or if you need more fine-grained control over what is happening during the deployment. Personally, I really like the BlueGreenDeploy plugin. It&rsquo;s easy to use and does the job.</p>

    </div>
  </div>
</section>

<section class="section">
  <div class="container">
    <aside><div id="disqus_thread"></div></aside>
    <script type="text/javascript">
      var disqus_shortname = 'berndsgnch';
      (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
  </div>
</section>


<section class="section">
  <div class="container has-text-centered">
    <p>&copy; <a href="https://bespinian.io">bespinian</a> 2020</p>
  </div>
</section>
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.6.0/highlight.min.js"></script>

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.6.0/languages/bash.min.js"></script>

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.6.0/languages/go.min.js"></script>

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.6.0/languages/html.min.js"></script>

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.6.0/languages/javascript.min.js"></script>

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.6.0/languages/json.min.js"></script>

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.6.0/languages/nginx.min.js"></script>

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.6.0/languages/php.min.js"></script>

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.6.0/languages/typescript.min.js"></script>

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.6.0/languages/yaml.min.js"></script>

<script>hljs.initHighlightingOnLoad();</script>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-132338301-2', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>



