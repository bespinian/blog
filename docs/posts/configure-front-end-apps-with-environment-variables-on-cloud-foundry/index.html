<!DOCTYPE html>
<html lang="en-us">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Configure Front End Apps With Environment Variables on Cloud Foundry | bespinian Blog</title>
<link rel="stylesheet" href="https://blog.bespinian.io//css/style.css">
<link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css">

<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.6.0/styles/androidstudio.min.css">


<section class="section">
  <div class="container">
    <nav class="nav">
      <div class="nav-left">
        <a class="nav-item" href="https://blog.bespinian.io/"><h1 class="title is-4">bespinian Blog</h1></a>
      </div>
      <div class="nav-right">
        <nav class="nav-item level is-mobile">
          
          <a class="level-item" href="https://github.com/bespinian">
            <span class="icon">
              <i class="fa fa-github"></i>
            </span>
          </a>
          
          <a class="level-item" href="https://twitter.com/bespinian">
            <span class="icon">
              <i class="fa fa-twitter"></i>
            </span>
          </a>
          
          <a class="level-item" href="/index.xml">
            <span class="icon">
              <i class="fa fa-rss"></i>
            </span>
          </a>
          
        </nav>
      </div>
    </nav>
  </div>
</section>

<section class="section">
  <div class="container">
    <h2 class="subtitle is-6">November 20, 2016</h2>
    <h1 class="title">Configure Front End Apps With Environment Variables on Cloud Foundry</h1>
    <div class="content">
      <p>The <a href="https://12factor.net/">12 factor manifest</a> tells us in point III that apps should retrieve their config from environment variables to <strong>strictly separate config from code</strong>. &ldquo;Config&rdquo; meaning everything that is likely to vary between deployments (staging, production, developer environments, etc). Cloud Foundry allows us to do that very easily using either the <code>manifest.yml</code> file or the <code>cf set-env</code> command. However, this only works for apps which have a dynamic back end. What if we want to configure a front end app that we have pushed to Cloud Foundry using the <a href="https://github.com/cloudfoundry/staticfile-buildpack">staticfile buildpack</a>? These apps are, by definition, static so they cannot read out any environment variables. Therefore, if we use this buildpack to deploy an <a href="https://angular.io/">Angular</a> or <a href="https://facebook.github.io/react/">React</a> app, we cannot use these variables.</p>
<p>Luckily, our <a href="https://www.nginx.com/">nginx</a> (the technology which the staticfile buildpack uses) server can do so. This gave us the idea to expose the configuration through an HTTP endpoint. The <code>nginx.conf</code> file is parsed by Ruby before it&rsquo;s being used by the buildpack to set up your nginx. So you can use the environment variables to configure a JSON endpoint to expose the configuration to your front end app.</p>
<h2 id="how-to">How To</h2>
<p>To get our custom configuration endpoint, we&rsquo;ll need to add the following block to a custom <code>nginx.conf</code> file residing in the root folder of our app:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-nginx" data-lang="nginx"><span style="color:#66d9ef">&lt;%</span> <span style="color:#e6db74">if</span> <span style="color:#e6db74">ENV[&#34;APP_CONFIG&#34;]</span> <span style="color:#e6db74">%&gt;</span>
<span style="color:#e6db74">location</span> <span style="color:#e6db74">/app-config</span> {
  <span style="color:#f92672">default_type</span> <span style="color:#e6db74">application/json</span>;
  <span style="color:#f92672">return</span> <span style="color:#ae81ff">200</span> <span style="color:#e6db74">&#39;&lt;%=</span> <span style="color:#e6db74">ENV[&#34;APP_CONFIG&#34;]</span> <span style="color:#e6db74">%&gt;&#39;</span>;
}
<span style="color:#66d9ef">&lt;%</span> <span style="color:#e6db74">end</span> <span style="color:#e6db74">%&gt;</span>
</code></pre></div><p>This will add an endpoint <code>/app-config</code> which exposes your configuration as JSON if the environment variable <code>APP_CONFIG</code> exists. If it doesn&rsquo;t exist, the endpoint won&rsquo;t be exposed at all.</p>
<p>If you don&rsquo;t have a custom <code>nginx.conf</code> yet, you can use this sample one which already includes the above code:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-nginx" data-lang="nginx"><span style="color:#66d9ef">worker_processes</span> <span style="color:#ae81ff">1</span>;
<span style="color:#66d9ef">daemon</span> <span style="color:#66d9ef">off</span>;

<span style="color:#66d9ef">error_log</span> <span style="color:#e6db74">&lt;%=</span> <span style="color:#e6db74">ENV[&#34;APP_ROOT&#34;]</span> <span style="color:#e6db74">%&gt;/nginx/logs/error.log</span>;
<span style="color:#66d9ef">events</span> { <span style="color:#f92672">worker_connections</span> <span style="color:#ae81ff">1024</span>; }

<span style="color:#66d9ef">http</span> {
  <span style="color:#f92672">charset</span> <span style="color:#e6db74">utf-8</span>;
  <span style="color:#f92672">log_format</span> <span style="color:#e6db74">cloudfoundry</span> <span style="color:#e6db74">&#39;</span>$http_x_forwarded_for <span style="color:#e6db74">-</span> $http_referer <span style="color:#e6db74">-</span> <span style="color:#e6db74">[</span>$time_local] <span style="color:#e6db74">&#34;</span>$request&#34; $status $body_bytes_sent&#39;;
  <span style="color:#f92672">access_log</span> <span style="color:#e6db74">&lt;%=</span> <span style="color:#e6db74">ENV[&#34;APP_ROOT&#34;]</span> <span style="color:#e6db74">%&gt;/nginx/logs/access.log</span> <span style="color:#e6db74">cloudfoundry</span>;
  <span style="color:#f92672">default_type</span> <span style="color:#e6db74">application/octet-stream</span>;
  <span style="color:#f92672">include</span> <span style="color:#e6db74">mime.types</span>;
  <span style="color:#f92672">sendfile</span> <span style="color:#66d9ef">on</span>;

  <span style="color:#f92672">gzip</span> <span style="color:#66d9ef">on</span>;
  <span style="color:#f92672">gzip_disable</span> <span style="color:#e6db74">&#34;msie6&#34;</span>;
  <span style="color:#f92672">gzip_comp_level</span> <span style="color:#ae81ff">6</span>;
  <span style="color:#f92672">gzip_min_length</span> <span style="color:#ae81ff">1100</span>;
  <span style="color:#f92672">gzip_buffers</span> <span style="color:#ae81ff">16</span> <span style="color:#ae81ff">8k</span>;
  <span style="color:#f92672">gzip_proxied</span> <span style="color:#e6db74">any</span>;
  <span style="color:#f92672">gunzip</span> <span style="color:#66d9ef">on</span>;
  <span style="color:#f92672">gzip_static</span> <span style="color:#e6db74">always</span>;
  <span style="color:#f92672">gzip_types</span> <span style="color:#e6db74">text/plain</span> <span style="color:#e6db74">text/css</span> <span style="color:#e6db74">text/js</span> <span style="color:#e6db74">text/xml</span> <span style="color:#e6db74">text/javascript</span> <span style="color:#e6db74">application/javascript</span> <span style="color:#e6db74">application/x-javascript</span> <span style="color:#e6db74">application/json</span> <span style="color:#e6db74">application/xml</span> <span style="color:#e6db74">application/xml+rss</span>;
  <span style="color:#f92672">gzip_vary</span> <span style="color:#66d9ef">on</span>;

  <span style="color:#f92672">tcp_nopush</span> <span style="color:#66d9ef">on</span>;
  <span style="color:#f92672">keepalive_timeout</span> <span style="color:#ae81ff">30</span>;
  <span style="color:#f92672">port_in_redirect</span> <span style="color:#66d9ef">off</span>; <span style="color:#75715e"># Ensure that redirects don&#39;t include the internal container PORT - &lt;%= ENV[&#34;PORT&#34;] %&gt;
</span><span style="color:#75715e"></span>  <span style="color:#f92672">server_tokens</span> <span style="color:#66d9ef">off</span>;

  <span style="color:#f92672">server</span> {
    <span style="color:#f92672">listen</span> <span style="color:#e6db74">&lt;%=</span> <span style="color:#e6db74">ENV[&#34;PORT&#34;]</span> <span style="color:#e6db74">%&gt;</span>;
    <span style="color:#f92672">server_name</span> <span style="color:#e6db74">localhost</span>;

    <span style="color:#f92672">location</span> <span style="color:#e6db74">/</span> {
      <span style="color:#f92672">root</span> <span style="color:#e6db74">&lt;%=</span> <span style="color:#e6db74">ENV[&#34;APP_ROOT&#34;]</span> <span style="color:#e6db74">%&gt;/public</span>;

      <span style="color:#f92672">index</span> <span style="color:#e6db74">index.html</span> <span style="color:#e6db74">index.htm</span> <span style="color:#e6db74">Default.htm</span>;

      <span style="color:#f92672">&lt;%</span> <span style="color:#e6db74">if</span> <span style="color:#e6db74">ENV[&#34;FORCE_HTTPS&#34;]</span> <span style="color:#e6db74">%&gt;</span>
        <span style="color:#e6db74">if</span> <span style="color:#e6db74">(</span>$http_x_forwarded_proto <span style="color:#e6db74">!=</span> <span style="color:#e6db74">&#34;https&#34;)</span> {
          <span style="color:#f92672">return</span> <span style="color:#ae81ff">301</span> <span style="color:#e6db74">https://</span>$host$request_uri;
        }
      <span style="color:#f92672">&lt;%</span> <span style="color:#e6db74">end</span> <span style="color:#e6db74">%&gt;</span>

      <span style="color:#e6db74">&lt;%</span> <span style="color:#e6db74">if</span> <span style="color:#e6db74">ENV[&#34;APP_CONFIG&#34;]</span> <span style="color:#e6db74">%&gt;</span>
      <span style="color:#e6db74">location</span> <span style="color:#e6db74">/app-config</span> {
        <span style="color:#f92672">default_type</span> <span style="color:#e6db74">application/json</span>;
        <span style="color:#f92672">return</span> <span style="color:#ae81ff">200</span> <span style="color:#e6db74">&#39;&lt;%=</span> <span style="color:#e6db74">ENV[&#34;APP_CONFIG&#34;]</span> <span style="color:#e6db74">%&gt;&#39;</span>;
      }
      <span style="color:#f92672">&lt;%</span> <span style="color:#e6db74">end</span> <span style="color:#e6db74">%&gt;</span>
    <span style="color:#960050;background-color:#1e0010">}</span>

  <span style="color:#960050;background-color:#1e0010">}</span>
<span style="color:#960050;background-color:#1e0010">}</span>
</code></pre></div><p>This config will work with the staticfile buildpack but disables some optional configurations of it. To add these back, you&rsquo;ll have to adjust the above code accordingly.</p>
<p>Now push your app with <code>cf push</code> and set the <code>APP_CONFIG</code> environment variable to some JSON string with the following command:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ cf push &lt;app-name&gt;
$ cf set-env &lt;app-name&gt; APP_CONFIG <span style="color:#e6db74">&#39;{&#34;apiUrl&#34;:&#34;https://jsonplaceholder.typicode.com&#34;}&#39;</span>
</code></pre></div><p>Now restage your app, as suggested, with:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ cf restage &lt;app-name&gt;
</code></pre></div><p>If you visit the <code>/app-config</code> endpoint of your app, it should return the specified JSON. Your front end app can now retrieve its config dynamically from that endpoint. You might have a fallback for all of these config items for local development if you use something like the <a href="https://webpack.github.io/docs/webpack-dev-server.html">webpack-dev-serer</a>. Of course, you can also configure your dev server to expose the same endpoint and create a development config for that.</p>
<h2 id="use-cases">Use Cases</h2>
<p>You can use this method to configure different environments your app might be running in. E.g. you might use a different API server for your integration environment than for your production environment.</p>
<p>Alternatively, you could use it to toggle feature flags dynamically to do <a href="https://en.wikipedia.org/wiki/A/B_testing">A/B testing</a> or a <a href="https://martinfowler.com/bliki/CanaryRelease.html">canary release</a>.</p>
<p>I&rsquo;m sure there are many more use cases but the main thing is, that this method allows you to have the single build job and then deploy that build to many different environments.</p>
<p>Many thanks to <a href="https://github.com/mkretz">@mkretz</a> for the inspiration for this post!</p>

    </div>
  </div>
</section>

<section class="section">
  <div class="container">
    <aside><div id="disqus_thread"></div></aside>
    <script type="text/javascript">
      var disqus_shortname = 'berndsgnch';
      (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
  </div>
</section>


<section class="section">
  <div class="container has-text-centered">
    <p>&copy; <a href="https://bespinian.io">bespinian</a> 2020</p>
  </div>
</section>
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.6.0/highlight.min.js"></script>

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.6.0/languages/bash.min.js"></script>

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.6.0/languages/go.min.js"></script>

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.6.0/languages/html.min.js"></script>

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.6.0/languages/javascript.min.js"></script>

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.6.0/languages/json.min.js"></script>

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.6.0/languages/nginx.min.js"></script>

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.6.0/languages/php.min.js"></script>

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.6.0/languages/typescript.min.js"></script>

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.6.0/languages/yaml.min.js"></script>

<script>hljs.initHighlightingOnLoad();</script>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-132338301-2', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>



