<!DOCTYPE html>
<html lang="en-us">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Observables With Angular and Feathers | bespinian Blog</title>
<link rel="stylesheet" href="https://blog.bespinian.io//css/style.css">
<link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css">

<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.6.0/styles/androidstudio.min.css">


<section class="section">
  <div class="container">
    <nav class="nav">
      <div class="nav-left">
        <a class="nav-item" href="https://blog.bespinian.io/"><h1 class="title is-4">bespinian Blog</h1></a>
      </div>
      <div class="nav-right">
        <nav class="nav-item level is-mobile">
          
          <a class="level-item" href="https://bespinian.io/">
            <span class="icon">
              <i class="fa fa-globe"></i>
            </span>
          </a>
          
          <a class="level-item" href="https://github.com/bespinian">
            <span class="icon">
              <i class="fa fa-github"></i>
            </span>
          </a>
          
          <a class="level-item" href="https://twitter.com/bespinian">
            <span class="icon">
              <i class="fa fa-twitter"></i>
            </span>
          </a>
          
          <a class="level-item" href="/index.xml">
            <span class="icon">
              <i class="fa fa-rss"></i>
            </span>
          </a>
          
        </nav>
      </div>
    </nav>
  </div>
</section>

<section class="section">
  <div class="container">
    <h2 class="subtitle is-6">March 14, 2016</h2>
    <h1 class="title">Observables With Angular and Feathers</h1>
    <div class="content">
      <p><a href="http://feathersjs.com">Feathers</a> is a modern API framework for Node.js. It exposes its backend services as a REST API or as a websocket API. To consume the exposed websockets from an Angular app, it makes sense to create Angular services to abstract the respective Feathers services in a way that makes it easy for our Angular components to consume them. This tutorial is assuming that you are using the <a href="https://github.com/angular/angular-cli">Angular CLI</a> for your app.</p>
<p>In my example, I&rsquo;ll use a simple todo service and a component that lists those todos.</p>
<h2 id="import-libraries">Import libraries</h2>
<p>As a first step we&rsquo;ll need to add the two libraries <code>socket.io-client</code> and <code>feathers-client</code> to our project. This can easily be done using npm:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ npm install --save socket.io-client feathers-client
</code></pre></div><p>The TypeScript typings of <code>feathers-client</code> are already included in the library. However, we need to include the ones for <code>socket.io-client</code> manually:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ npm install --save @types/socket.io-client
</code></pre></div><h2 id="create-base-api-service">Create base API service</h2>
<p>Then we create an abstract class to extend upon, which contains the basic properties of a backend service:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#75715e">// src/app/api.service.ts
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">export</span> <span style="color:#66d9ef">abstract</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ApiService</span> {
  <span style="color:#66d9ef">private</span> <span style="color:#a6e22e">_url</span>: <span style="color:#66d9ef">string</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;https://my-todos-api.com&#34;</span>;

  <span style="color:#a6e22e">get</span> <span style="color:#a6e22e">url</span>()<span style="color:#f92672">:</span> <span style="color:#66d9ef">string</span> {
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">_url</span>;
  }
}
</code></pre></div><h2 id="create-data-model">Create data model</h2>
<p>Next, we create a class to represent our todo&rsquo;s data model:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#75715e">// src/app/todos/todo.ts
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">export</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Todo</span> {
  <span style="color:#a6e22e">title</span>: <span style="color:#66d9ef">string</span>;
}
</code></pre></div><h2 id="create-actual-service">Create actual service</h2>
<p>Then we create the actual service which connects to the Feathers backend and exposes it as a service in Angular. It inherits from the base service we&rsquo;ve created above. The Feathers service is exposed as an RxJS <code>Obersvable</code> which our components can then subscribe to:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#75715e">// src/app/todos/todo.service.ts
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">Injectable</span> } <span style="color:#a6e22e">from</span> <span style="color:#e6db74">&#34;@angular/core&#34;</span>;
<span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">Observable</span> } <span style="color:#a6e22e">from</span> <span style="color:#e6db74">&#34;rxjs/Observable&#34;</span>;
<span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">Observer</span> } <span style="color:#a6e22e">from</span> <span style="color:#e6db74">&#34;rxjs/Observer&#34;</span>;
<span style="color:#66d9ef">import</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">as</span> <span style="color:#a6e22e">io</span> <span style="color:#a6e22e">from</span> <span style="color:#e6db74">&#34;socket.io-client&#34;</span>;
<span style="color:#66d9ef">import</span> <span style="color:#a6e22e">feathers</span> <span style="color:#a6e22e">from</span> <span style="color:#e6db74">&#34;feathers-client&#34;</span>;

<span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">ApiService</span> } <span style="color:#a6e22e">from</span> <span style="color:#e6db74">&#34;../api.service&#34;</span>;
<span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">Todo</span> } <span style="color:#a6e22e">from</span> <span style="color:#e6db74">&#34;./todo&#34;</span>;

<span style="color:#66d9ef">@Injectable</span>()
<span style="color:#66d9ef">export</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">TodoService</span> <span style="color:#66d9ef">extends</span> <span style="color:#a6e22e">APIService</span> {
  <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">todos$</span>: <span style="color:#66d9ef">Observable</span>&lt;<span style="color:#f92672">Todo</span><span style="color:#960050;background-color:#1e0010">[]</span>&gt;;
  <span style="color:#66d9ef">private</span> <span style="color:#a6e22e">todosObserver</span>: <span style="color:#66d9ef">Observer</span>&lt;<span style="color:#f92672">Todo</span><span style="color:#960050;background-color:#1e0010">[]</span>&gt;;
  <span style="color:#66d9ef">private</span> <span style="color:#a6e22e">feathersService</span>: <span style="color:#66d9ef">any</span>;
  <span style="color:#66d9ef">private</span> <span style="color:#a6e22e">dataStore</span><span style="color:#f92672">:</span> {
    <span style="color:#a6e22e">todos</span>: <span style="color:#66d9ef">Todo</span>[];
  };

  <span style="color:#66d9ef">constructor</span>() {
    <span style="color:#66d9ef">super</span>();

    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">socket</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">io</span>(<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">url</span>);
    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">client</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">feathers</span>().<span style="color:#a6e22e">configure</span>(<span style="color:#a6e22e">feathers</span>.<span style="color:#a6e22e">socketio</span>(<span style="color:#a6e22e">socket</span>));
    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">feathersService</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">service</span>(<span style="color:#e6db74">&#34;todo&#34;</span>);

    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">feathersService</span>.<span style="color:#a6e22e">on</span>(<span style="color:#e6db74">&#34;created&#34;</span>, (<span style="color:#a6e22e">todo</span>) <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">onCreated</span>(<span style="color:#a6e22e">todo</span>));
    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">feathersService</span>.<span style="color:#a6e22e">on</span>(<span style="color:#e6db74">&#34;updated&#34;</span>, (<span style="color:#a6e22e">todo</span>) <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">onUpdated</span>(<span style="color:#a6e22e">todo</span>));
    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">feathersService</span>.<span style="color:#a6e22e">on</span>(<span style="color:#e6db74">&#34;removed&#34;</span>, (<span style="color:#a6e22e">todo</span>) <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">onRemoved</span>(<span style="color:#a6e22e">todo</span>));

    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">todos$</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Observable</span>((<span style="color:#a6e22e">observer</span>) <span style="color:#f92672">=&gt;</span> (<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">todosObserver</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">observer</span>));

    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">dataStore</span> <span style="color:#f92672">=</span> { <span style="color:#a6e22e">todos</span><span style="color:#f92672">:</span> [] };
  }

  <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">find() {</span>
    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">feathersService</span>.<span style="color:#a6e22e">find</span>((<span style="color:#a6e22e">err</span>, <span style="color:#a6e22e">todos</span>: <span style="color:#66d9ef">Todo</span>[]) <span style="color:#f92672">=&gt;</span> {
      <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">err</span>) <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">error</span>(<span style="color:#a6e22e">err</span>);

      <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">dataStore</span>.<span style="color:#a6e22e">todos</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">todos</span>;
      <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">todosObserver</span>.<span style="color:#a6e22e">next</span>(<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">dataStore</span>.<span style="color:#a6e22e">todos</span>);
    });
  }

  <span style="color:#66d9ef">private</span> <span style="color:#a6e22e">getIndex</span>(<span style="color:#a6e22e">id</span>: <span style="color:#66d9ef">string</span>)<span style="color:#f92672">:</span> <span style="color:#66d9ef">number</span> {
    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">foundIndex</span> <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;

    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> <span style="color:#f92672">&lt;</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">dataStore</span>.<span style="color:#a6e22e">todos</span>.<span style="color:#a6e22e">length</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span>) {
      <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">dataStore</span>.<span style="color:#a6e22e">todos</span>[<span style="color:#a6e22e">i</span>].<span style="color:#a6e22e">id</span> <span style="color:#f92672">===</span> <span style="color:#a6e22e">id</span>) {
        <span style="color:#a6e22e">foundIndex</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">i</span>;
      }
    }

    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">foundIndex</span>;
  }

  <span style="color:#66d9ef">private</span> <span style="color:#a6e22e">onCreated</span>(<span style="color:#a6e22e">todo</span>: <span style="color:#66d9ef">Todo</span>) {
    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">dataStore</span>.<span style="color:#a6e22e">todos</span>.<span style="color:#a6e22e">push</span>(<span style="color:#a6e22e">todo</span>);

    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">todosObserver</span>.<span style="color:#a6e22e">next</span>(<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">dataStore</span>.<span style="color:#a6e22e">todos</span>);
  }

  <span style="color:#66d9ef">private</span> <span style="color:#a6e22e">onUpdated</span>(<span style="color:#a6e22e">todo</span>: <span style="color:#66d9ef">Todo</span>) {
    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">index</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">getIndex</span>(<span style="color:#a6e22e">todo</span>.<span style="color:#a6e22e">id</span>);

    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">dataStore</span>.<span style="color:#a6e22e">todos</span>[<span style="color:#a6e22e">index</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">todo</span>;

    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">todosObserver</span>.<span style="color:#a6e22e">next</span>(<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">dataStore</span>.<span style="color:#a6e22e">todos</span>);
  }

  <span style="color:#66d9ef">private</span> <span style="color:#a6e22e">onRemoved</span>(<span style="color:#a6e22e">todo</span>) {
    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">index</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">getIndex</span>(<span style="color:#a6e22e">todo</span>.<span style="color:#a6e22e">id</span>);

    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">dataStore</span>.<span style="color:#a6e22e">todos</span>.<span style="color:#a6e22e">splice</span>(<span style="color:#a6e22e">index</span>, <span style="color:#ae81ff">1</span>);

    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">todosObserver</span>.<span style="color:#a6e22e">next</span>(<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">dataStore</span>.<span style="color:#a6e22e">todos</span>);
  }
}
</code></pre></div><h2 id="consume-from-component">Consume from component</h2>
<p>Now, our Angular service is ready. To use the <code>Observable</code> it exposes in an Angular component, follow the structure below:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#75715e">// todos/todos.component.ts
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">import</span> {
  <span style="color:#a6e22e">ChangeDetectorRef</span>,
  <span style="color:#a6e22e">ChangeDetectionStrategy</span>,
  <span style="color:#a6e22e">Component</span>,
  <span style="color:#a6e22e">OnDestroy</span>,
  <span style="color:#a6e22e">OnInit</span>,
} <span style="color:#a6e22e">from</span> <span style="color:#e6db74">&#34;@angular/core&#34;</span>;
<span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">Subscription</span> } <span style="color:#a6e22e">from</span> <span style="color:#e6db74">&#34;rxjs/Subscription&#34;</span>;

<span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">TodoService</span> } <span style="color:#a6e22e">from</span> <span style="color:#e6db74">&#34;./todo.service&#34;</span>;
<span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">Todo</span> } <span style="color:#a6e22e">from</span> <span style="color:#e6db74">&#34;./todo&#34;</span>;

<span style="color:#66d9ef">@Component</span>({
  <span style="color:#a6e22e">selector</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;app-todos&#34;</span>,
  <span style="color:#a6e22e">providers</span><span style="color:#f92672">:</span> [<span style="color:#a6e22e">TodoService</span>],
  <span style="color:#a6e22e">changeDetection</span>: <span style="color:#66d9ef">ChangeDetectionStrategy.OnPush</span>,
  <span style="color:#a6e22e">templateUrl</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;./todos.component.html&#34;</span>,
})
<span style="color:#66d9ef">export</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">TodosComponent</span> <span style="color:#66d9ef">implements</span> <span style="color:#a6e22e">OnDestroy</span>, <span style="color:#a6e22e">OnInit</span> {
  <span style="color:#66d9ef">private</span> <span style="color:#a6e22e">todos</span>: <span style="color:#66d9ef">Todo</span>[] <span style="color:#f92672">=</span> [];
  <span style="color:#66d9ef">private</span> <span style="color:#a6e22e">subscription</span>: <span style="color:#66d9ef">Subscription</span>;

  <span style="color:#66d9ef">constructor</span>(
    <span style="color:#66d9ef">private</span> <span style="color:#a6e22e">todoService</span>: <span style="color:#66d9ef">TodoService</span>,
    <span style="color:#66d9ef">private</span> <span style="color:#a6e22e">ref</span>: <span style="color:#66d9ef">ChangeDetectorRef</span>
  ) {}

  <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">ngOnInit</span>()<span style="color:#f92672">:</span> <span style="color:#66d9ef">void</span> {
    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">subscription</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">todoService</span>.<span style="color:#a6e22e">todos$</span>.<span style="color:#a6e22e">subscribe</span>(
      (<span style="color:#a6e22e">todos</span>: <span style="color:#66d9ef">Todo</span>[]) <span style="color:#f92672">=&gt;</span> {
        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">todos</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">todos</span>;
        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">ref</span>.<span style="color:#a6e22e">markForCheck</span>();
      },
      (<span style="color:#a6e22e">err</span>) <span style="color:#f92672">=&gt;</span> {
        <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">error</span>(<span style="color:#a6e22e">err</span>);
      }
    );
    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">todoService</span>.<span style="color:#a6e22e">find</span>();
  }

  <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">ngOnDestroy() {</span>
    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">subscription</span>.<span style="color:#a6e22e">unsubscribe</span>();
  }
}
</code></pre></div><p>Our component <code>TodosComponent</code> now has a property <code>todos</code> which contains the todos it gets from the respective Feathers service and which can be used in the app. It live-updates the UI every time a todo in the Feathers API is removed or added.</p>

    </div>
  </div>
</section>

<section class="section">
  <div class="container">
    <aside><div id="disqus_thread"></div></aside>
    <script type="text/javascript">
      var disqus_shortname = 'berndsgnch';
      (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
  </div>
</section>


<section class="section">
  <div class="container has-text-centered">
    <p>&copy; <a href="https://bespinian.io">bespinian</a> 2020</p>
  </div>
</section>
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.6.0/highlight.min.js"></script>

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.6.0/languages/bash.min.js"></script>

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.6.0/languages/go.min.js"></script>

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.6.0/languages/html.min.js"></script>

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.6.0/languages/javascript.min.js"></script>

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.6.0/languages/json.min.js"></script>

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.6.0/languages/nginx.min.js"></script>

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.6.0/languages/php.min.js"></script>

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.6.0/languages/typescript.min.js"></script>

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.6.0/languages/yaml.min.js"></script>

<script>hljs.initHighlightingOnLoad();</script>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-132338301-2', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>



